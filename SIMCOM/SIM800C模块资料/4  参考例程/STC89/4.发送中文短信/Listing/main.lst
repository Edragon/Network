C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: E:\mcu_keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(..\Listing\main.lst) TABS(2) OBJ
                    -ECT(..\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  :²¦´òµç»°
   3           * ÃèÊö    :Í¨¹ýC51¿ª·¢°å¿ØÖÆÄ£¿é²¦´òÖ¸¶¨µç»°ºÅ
   4           * ÊµÑéÆ½Ì¨:C51
   5           * ¿â°æ±¾  :
   6          
   7           * Ó²¼þÁ¬½ÓËµÃ÷
   8             Ê¹ÓÃµ¥Æ¬´®¿ÚÓëGPRSÄ£¿éÍ¨ÐÅ 
   9             C51        GPRSÄ£¿é
  10             P30 (RXD)->RXD
  11             P31 (TXD)->TXD
  12             GND      ->GND£
  13          
  14           * Èí¼þ¹¦ÄÜËµÃ÷
  15             °å×ÓÉÏµçºóÔËÐÐÖ¸Ê¾µÆRUNING_LED»áÒÔÒ»ÃëµÄÆµÂÊÉÁË¸
  16             ´ò¿ª´úÂëÐÞ¸Ä¶ÌÐÅÖÐÐÄºÅ¡¢½ÓÊÕ·½ÊÖ»úºÅºÍ¶ÌÐÅÄÚÈÝ£¬±àÒë³É¹¦ºóÏÂÔØµ½µ¥Æ¬»úÀïÃæ£¬
  17             ¾Í¿ÉÒÔÊµÏÖ·¢ËÍÒ»ÌõÖÐÎÄ¶ÌÐÅ£¬ÖÐÎÄ¶ÌÐÅ¾ßÌåµÄ½âÎö¿ÉÒÔ²Î¿¼´®¿Úµ÷ÊÔ±Ê¼Ç
  18          **********************************************************************************/
  19          #include "config.h"
  20          #include "string.h"
  21          #include "delay.h"
  22          #include "uart.h"
  23          
  24          
  25          #define Buf1_Max 200            //´®¿Ú2»º´æ³¤¶È
  26          /*************  ±¾µØ³£Á¿ÉùÃ÷  **************/
  27          sbit RUNING_LED = P3^2;         //ÔËÐÐÖ¸Ê¾µÆ
  28          
  29          static unsigned char *content="0891683108706505F011000D91683197985889F90008AA0C6D4B8BD55DF27ECF5B8C6210";/
             -/·¢ËÍ¶ÌÐÅÄÚÈÝ
  30          /************************¶ÌÐÅÄÚÈÝ½âÎö**************************************/
  31          /*
  32             //¶ÌÐÅÖÐÐÄºÅ£¨µ¹Ðò£©      Ä¿±êÊÖ»ú£¨µ¹Ðò£©         ¶ÌÐÅÄÚÈÝ£¨²âÊÔÒÑ¾­Íê³É£©
  33               8613800756500F          8613798985989F          
  34          0891 683108706505F0 11000D91 683197985889F9 0008AA0C 6D4B8BD55DF27ECF5B8C6210
  35          
  36          */
  37          /*************  ±¾µØ±äÁ¿ÉùÃ÷  **************/
  38          
  39          xdata u8 Uart1_Buf[Buf1_Max];
  40          
  41          u8 Times=0,First_Int = 0,shijian=0;
  42          
  43          bdata u8 Flag;//¶¨Ê±Æ÷±êÖ¾Î»
  44          sbit Timer0_start =Flag^0;  //¶¨Ê±Æ÷0ÑÓÊ±Æô¶¯¼ÆÊýÆ÷
  45          
  46          
  47          
  48          /*************  ±¾µØº¯ÊýÉùÃ÷  **************/
  49          void GPIO_config(void); //¶Ë¿Ú³õÊ¼»¯ÅäÖÃ
  50          void Timer0Init(void);  //¶¨Ê±Æ÷0³õÊ¼»¯
  51          void CLR_Buf1(void);    //Çå³ý´®¿Ú2½ÓÊÕ»º´æ
  52          u8 Find(u8 *a);         //²éÕÒ×Ö·û´®
  53          void Second_AT_Command(u8 *b,u8 *a,u8 wait_time); //·¢ËÍATÖ¸Áîº¯Êý
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 2   

  54          void Set_Pdu_Mode(void);//ÉèÖÃ¶ÌÐÅÄ£Ê½PDU
  55          void Wait_CREG(void);   //²éÑ¯µÈ´ýÄ£¿é×¢²á³É¹¦
  56          void Send_Pdu_Sms(void);//·¢ËÍÒ»ÌõÖÐÎÄ¶ÌÐÅ
  57          /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷*****************/
  58          
  59          
  60          
  61          
  62          /*******************************************************************************
  63          * º¯ÊýÃû : main 
  64          * ÃèÊö   : Ö÷º¯Êý
  65          * ÊäÈë   : 
  66          * Êä³ö   : 
  67          * ·µ»Ø   : 
  68          * ×¢Òâ   : ´®¿Ú²¨ÌØÂÊÊÇ9600£¬GPRSÄ£¿éÄ¬ÈÏ²¨ÌØÂÊÊÇ115200£¬ÐèÒª×Ô¼ºÍ¨¹ý´®¿ÚÖúÊÖÐÞ¸Ä
  69                     Îª9600·½¿ÉÊ¹ÓÃ¡£ 
  70          *******************************************************************************/
  71          void main(void)
  72          {
  73   1        Timer0Init();  //³õÊ¼»¯¶¨Ê±Æ÷0
  74   1        GPIO_config();
  75   1        EA=1; //¿ª×ÜÖÐ¶Ï
  76   1        Uart1Init();    //³õÊ¼»¯´®¿Ú9600
  77   1        Wait_CREG();    //²éÑ¯µÈ´ýÄ£¿é×¢²á³É¹¦
  78   1        Set_Pdu_Mode();//ÉèÖÃ¶ÌÐÅÎªPDUÄ£Ê½
  79   1        Send_Pdu_Sms();//·¢ËÍÒ»Ìõ¶ÌÏûÏ¢
  80   1        while(1)
  81   1        {
  82   2          ;
  83   2        }
  84   1        
  85   1      }
  86          
  87          /*******************************************************************************
  88          * º¯ÊýÃû : Uart1 
  89          * ÃèÊö   : ´®¿Ú1ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
  90          * ÊäÈë   : 
  91          * Êä³ö   : 
  92          * ·µ»Ø   : 
  93          * ×¢Òâ   : 
  94          *******************************************************************************/
  95          void Uart1() interrupt 4
  96          {
  97   1          if (RI)
  98   1          {
  99   2            RI = 0;                 //Çå³ýRIÎ»
 100   2            Uart1_Buf[First_Int] = SBUF;      //½«½ÓÊÕµ½µÄ×Ö·û´®´æµ½»º´æÖÐ
 101   2            First_Int++;                      //»º´æÖ¸ÕëÏòºóÒÆ¶¯
 102   2            if(First_Int > Buf1_Max)          //Èç¹û»º´æÂú,½«»º´æÖ¸ÕëÖ¸Ïò»º´æµÄÊ×µØÖ·
 103   2            {
 104   3              First_Int = 0;
 105   3            }
 106   2          }
 107   1          if (TI)
 108   1          {
 109   2              TI = 0;                 //Çå³ýTIÎ»
 110   2          }
 111   1      }
 112          /*******************************************************************************
 113          * º¯ÊýÃû : Timer0_ISR
 114          * ÃèÊö   : ¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñÈë¿Úº¯Êý,20msÖÐ¶ÏÒ»´Î
 115          * ÊäÈë   : 
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 3   

 116          * Êä³ö   : 
 117          * ·µ»Ø   : 
 118          * ×¢Òâ   : 
 119          *******************************************************************************/
 120          void Timer0_ISR() interrupt 1
 121          {
 122   1        static u8 Time_count=0;
 123   1        TL0 = 0x00;     //ÖØÖÃ¶¨Ê±Æ÷³õÖµ
 124   1        TH0 = 0xB8;     //ÖØÖÃ¶¨Ê±Æ÷³õÖµ  
 125   1        TR0=0;//¹Ø¶¨Ê±Æ÷
 126   1        Time_count++;
 127   1        if(Time_count>=50)
 128   1        {
 129   2          Time_count = 0;
 130   2          RUNING_LED =~RUNING_LED;
 131   2        }
 132   1        if(count_20ms) //20msÑÓÊ±¼ÆÊýÆ÷
 133   1          count_20ms--;
 134   1        if(Timer0_start)
 135   1        Times++;
 136   1        if(Times > (50*shijian))
 137   1        {
 138   2          Timer0_start = 0;
 139   2          Times = 0;
 140   2        }
 141   1        TR0=1;//¿ª¶¨Ê±Æ÷
 142   1      }
 143          /*******************************************************************************
 144          * º¯ÊýÃû : GPIO_config
 145          * ÃèÊö   : IO¿ÚÅäÖÃº¯Êý
 146          * ÊäÈë   : 
 147          * Êä³ö   : 
 148          * ·µ»Ø   : 
 149          * ×¢Òâ   : 
 150          *******************************************************************************/
 151          void  GPIO_config(void)
 152          {
 153   1          RUNING_LED=0;
 154   1      }
 155          /*******************************************************************************
 156          * º¯ÊýÃû : Timer0Init
 157          * ÃèÊö   : ¶¨Ê±Æ÷0³õÊ¼»¯£¬20ms¶¨Ê±
 158          * ÊäÈë   : 
 159          * Êä³ö   : 
 160          * ·µ»Ø   : 
 161          * ×¢Òâ   : 
 162          *******************************************************************************/
 163          void Timer0Init(void)   //20ºÁÃë@11.0592MHz
 164          {
 165   1        AUXR &= 0x7F;   //¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
 166   1        TMOD &= 0xF0;   //
 167   1        TMOD |= 0x01;   //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½£¬16Î»¶¨Ê±Æ÷
 168   1        TL0 = 0x00;     //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 169   1        TH0 = 0xB8;     //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 170   1        TF0 = 0;        //ÇåTF0±êÖ¾
 171   1        TR0 = 1;        //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 172   1        ET0 = 1;        //Ê¹ÄÜ¶¨Ê±Æ÷0ÖÐ¶Ï
 173   1      }
 174          /*******************************************************************************
 175          * º¯ÊýÃû : CLR_Buf1
 176          * ÃèÊö   : Çå³ý´®¿Ú2»º´æÊý¾Ý
 177          * ÊäÈë   : 
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 4   

 178          * Êä³ö   : 
 179          * ·µ»Ø   : 
 180          * ×¢Òâ   : 
 181          *******************************************************************************/
 182          void CLR_Buf1(void)
 183          {
 184   1        u16 k;
 185   1        for(k=0;k<Buf1_Max;k++)      //½«»º´æÄÚÈÝÇåÁã
 186   1        {
 187   2          Uart1_Buf[k] = 0x00;
 188   2        }
 189   1          First_Int = 0;              //½ÓÊÕ×Ö·û´®µÄÆðÊ¼´æ´¢Î»ÖÃ
 190   1      }
 191          
 192          /*******************************************************************************
 193          * º¯ÊýÃû : Find
 194          * ÃèÊö   : ÅÐ¶Ï»º´æÖÐÊÇ·ñº¬ÓÐÖ¸¶¨µÄ×Ö·û´®
 195          * ÊäÈë   : 
 196          * Êä³ö   : 
 197          * ·µ»Ø   : unsigned char:1 ÕÒµ½Ö¸¶¨×Ö·û£¬0 Î´ÕÒµ½Ö¸¶¨×Ö·û 
 198          * ×¢Òâ   : 
 199          *******************************************************************************/
 200          
 201          u8 Find(u8 *a)
 202          { 
 203   1        if(strstr(Uart1_Buf,a)!=NULL)
 204   1            return 1;
 205   1        else
 206   1            return 0;
 207   1      }
 208          
 209          /*******************************************************************************
 210          * º¯ÊýÃû : Second_AT_Command
 211          * ÃèÊö   : ·¢ËÍATÖ¸Áîº¯Êý
 212          * ÊäÈë   : ·¢ËÍÊý¾ÝµÄÖ¸Õë¡¢·¢ËÍµÈ´ýÊ±¼ä(µ¥Î»£ºS)
 213          * Êä³ö   : 
 214          * ·µ»Ø   : 
 215          * ×¢Òâ   : 
 216          *******************************************************************************/
 217          
 218          void Second_AT_Command(u8 *b,u8 *a,u8 wait_time)         
 219          {
 220   1        u8 i;
 221   1        u8 *c;
 222   1        c = b;                    //±£´æ×Ö·û´®µØÖ·µ½c
 223   1        CLR_Buf1(); 
 224   1        i = 0;
 225   1        while(i == 0)                    
 226   1        {
 227   2          if(!Find(a))           //²éÕÒÐèÒªÓ¦´ðµÄ×Ö·û
 228   2          {
 229   3            if(Timer0_start == 0)//³¬Ê±ÖØÐÂ·¢ËÍÃüÁî
 230   3            {
 231   4              b = c;             //½«×Ö·û´®µØÖ·¸øb
 232   4              for (b; *b!='\0';b++)
 233   4              {
 234   5                UART1_SendData(*b);
 235   5              }
 236   4              UART1_SendLR(); 
 237   4              Times = 0;
 238   4              shijian = wait_time;
 239   4              Timer0_start = 1;  //¿ªÊ¼¼ÆÊ±
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 5   

 240   4             }
 241   3          }
 242   2          else
 243   2          {
 244   3            i = 1;
 245   3            Timer0_start = 0;  
 246   3          }
 247   2        }
 248   1        CLR_Buf1(); 
 249   1      }
 250          
 251          /*******************************************************************************
 252          * º¯ÊýÃû : Set_Pdu_Mode
 253          * ÃèÊö   : ÉèÖÃ¶ÌÐÅÎªTEXTÎÄ±¾Ä£Ê½
 254          * ÊäÈë   : 
 255          * Êä³ö   : 
 256          * ·µ»Ø   : 
 257          * ×¢Òâ   : 
 258          *******************************************************************************/
 259          void Set_Pdu_Mode(void)
 260          {
 261   1        Second_AT_Command("ATE0","OK",3);                     //È¡Ïû»ØÏÔ  
 262   1        Second_AT_Command("AT+CMGF=0","OK",3);                //ÉèÖÃPDUÄ£Ê½ 
 263   1        Second_AT_Command("AT+CPMS=\"SM\",\"SM\",\"SM\"","OK",3);//ËùÓÐ²Ù×÷¶¼ÔÚSIM¿¨ÖÐ½øÐÐ
 264   1      }
 265          /*******************************************************************************
 266          * º¯ÊýÃû : Send_Pdu_Sms
 267          * ÃèÊö   : ·¢ËÍPDUÎÄ±¾¶ÌÐÅ
 268          * ÊäÈë   : 
 269          * Êä³ö   : 
 270          * ·µ»Ø   : 
 271          * ×¢Òâ   : 
 272          *******************************************************************************/
 273          void Send_Pdu_Sms(void)
 274          {
 275   1      
 276   1        Second_AT_Command("AT+CMGS=27",">",3); //·¢ËÍÊý¾Ý³¤¶È£º27£¨¾ßÌåµÄ¼ÆËã·½·¨¿´´®¿Úµ÷ÊÔ±È½Ï£©½ÓÊÕµ½¡°>¡±²Å·¢Ë
             -Í¶ÌÐÅÄÚÈÝ
 277   1        UART1_SendString(content);     //·¢ËÍ¶ÌÐÅÄÚÈÝ
 278   1        UART1_SendData(0X1A);          //·¢ËÍ½áÊø·û
 279   1      }
 280          
 281          /*******************************************************************************
 282          * º¯ÊýÃû : Wait_CREG
 283          * ÃèÊö   : µÈ´ýÄ£¿é×¢²á³É¹¦
 284          * ÊäÈë   : 
 285          * Êä³ö   : 
 286          * ·µ»Ø   : 
 287          * ×¢Òâ   : 
 288          *******************************************************************************/
 289          void Wait_CREG(void)
 290          {
 291   1        u8 i;
 292   1        u8 k;
 293   1        i = 0;
 294   1        CLR_Buf1();
 295   1        while(i == 0)             
 296   1        {
 297   2          CLR_Buf1();        
 298   2          UART1_SendString("AT+CREG?");//²éÑ¯Ä£¿éÍøÂç×¢²á×´Ì¬
 299   2          UART1_SendLR();
 300   2          delay_ms(250);              
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:52:23 PAGE 6   

 301   2            for(k=0;k<Buf1_Max;k++)           
 302   2            {
 303   3            if(Uart1_Buf[k] == ':')
 304   3            {
 305   4              if((Uart1_Buf[k+4] == '1')||(Uart1_Buf[k+4] == '5')) //±íÃ÷ÍøÂç×¢²á³É¹¦
 306   4              {
 307   5                i = 1;
 308   5                break;
 309   5              }
 310   4            }
 311   3          }
 312   2        }
 313   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    528    ----
   CONSTANT SIZE    =    136    ----
   XDATA SIZE       =    200    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      16
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
