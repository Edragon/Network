/**********************************************************************************
 *   :绰
 *     :ͨC51ģ鲦ָ绰
 * ʵƽ̨:C51
 * 汾  :

 * Ӳ˵
	 ʹõƬGPRSģͨ 
	 C51        GPRSģ
	 P30 (RXD)->RXD
	 P31 (TXD)->TXD
	 GND	    ->GND

 * ˵
   ϵָʾRUNING_LEDһƵ˸
	 򿪴޸ĶĺšշֻźͶݣɹصƬ棬
	 ͿʵַһĶţĶžĽԲοڵԱʼ
**********************************************************************************/
#include "config.h"
#include "string.h"
#include "delay.h"
#include "uart.h"


#define Buf1_Max 200 					  //2泤
/*************	س	**************/
sbit RUNING_LED = P3^2;					//ָʾ

static unsigned char *content="0891683108706505F011000D91683197985889F90008AA0C6D4B8BD55DF27ECF5B8C6210";//Ͷ
/************************ݽ**************************************/
/*
   //ĺţ      Ŀֻ         ݣѾɣ
     8613800756500F          8613798985989F          
0891 683108706505F0 11000D91 683197985889F9 0008AA0C 6D4B8BD55DF27ECF5B8C6210

*/
/*************  ر	**************/

xdata u8 Uart1_Buf[Buf1_Max];

u8 Times=0,First_Int = 0,shijian=0;

bdata u8 Flag;//ʱ־λ
sbit Timer0_start =Flag^0;	//ʱ0ʱ



/*************	غ	**************/
void GPIO_config(void); //˿ڳʼ
void Timer0Init(void);  //ʱ0ʼ
void CLR_Buf1(void);    //2ջ
u8 Find(u8 *a);         //ַ
void Second_AT_Command(u8 *b,u8 *a,u8 wait_time); //ATָ
void Set_Pdu_Mode(void);//öģʽPDU
void Wait_CREG(void);   //ѯȴģעɹ
void Send_Pdu_Sms(void);//һĶ
/*************  ⲿͱ*****************/




/*******************************************************************************
*  : main 
*    : 
*    : 
*    : 
*    : 
* ע   : ڲ9600GPRSģĬϲ115200ҪԼͨ޸
				   Ϊ9600ʹá 
*******************************************************************************/
void main(void)
{
	Timer0Init();  //ʼʱ0
	GPIO_config();
	EA=1;	//ж
	Uart1Init();    //ʼ9600
	Wait_CREG();    //ѯȴģעɹ
	Set_Pdu_Mode();//öΪPDUģʽ
	Send_Pdu_Sms();//һϢ
	while(1)
	{
		;
	}
	
}

/*******************************************************************************
*  : Uart1 
*    : 1жϷں
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Uart1() interrupt 4
{
    if (RI)
    {
      RI = 0;                 //RIλ
			Uart1_Buf[First_Int] = SBUF;  	  //յַ浽
			First_Int++;                			//ָƶ
			if(First_Int > Buf1_Max)       		//,ָָ򻺴׵ַ
			{
				First_Int = 0;
			}
    }
    if (TI)
    {
        TI = 0;                 //TIλ
    }
}
/*******************************************************************************
*  : Timer0_ISR
*    : ʱ0жϷں,20msжһ
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Timer0_ISR() interrupt 1
{
	static u8 Time_count=0;
  TL0 = 0x00;		  //öʱֵ
	TH0 = 0xB8;		  //öʱֵ	
	TR0=0;//ضʱ
	Time_count++;
	if(Time_count>=50)
	{
		Time_count = 0;
		RUNING_LED =~RUNING_LED;
	}
	if(count_20ms) //20msʱ
		count_20ms--;
	if(Timer0_start)
	Times++;
	if(Times > (50*shijian))
	{
		Timer0_start = 0;
		Times = 0;
	}
	TR0=1;//ʱ
}
/*******************************************************************************
*  : GPIO_config
*    : IOú
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void	GPIO_config(void)
{
		RUNING_LED=0;
}
/*******************************************************************************
*  : Timer0Init
*    : ʱ0ʼ20msʱ
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Timer0Init(void)		//20@11.0592MHz
{
	AUXR &= 0x7F;		//ʱʱ12Tģʽ
	TMOD &= 0xF0;		//
	TMOD |= 0x01;		//öʱģʽ16λʱ
	TL0 = 0x00;		  //öʱֵ
	TH0 = 0xB8;		  //öʱֵ
	TF0 = 0;		    //TF0־
	TR0 = 1;		    //ʱ0ʼʱ
	ET0 = 1;    	  //ʹܶʱ0ж
}
/*******************************************************************************
*  : CLR_Buf1
*    : 2
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void CLR_Buf1(void)
{
	u16 k;
	for(k=0;k<Buf1_Max;k++)      //
	{
		Uart1_Buf[k] = 0x00;
	}
    First_Int = 0;              //ַʼ洢λ
}

/*******************************************************************************
*  : Find
*    : жϻǷַָ
*    : 
*    : 
*    : unsigned char:1 ҵַָ0 δҵַָ 
* ע   : 
*******************************************************************************/

u8 Find(u8 *a)
{ 
  if(strstr(Uart1_Buf,a)!=NULL)
	    return 1;
	else
			return 0;
}

/*******************************************************************************
*  : Second_AT_Command
*    : ATָ
*    : ݵָ롢͵ȴʱ(λS)
*    : 
*    : 
* ע   : 
*******************************************************************************/

void Second_AT_Command(u8 *b,u8 *a,u8 wait_time)         
{
	u8 i;
	u8 *c;
	c = b;										//ַַc
	CLR_Buf1(); 
  i = 0;
	while(i == 0)                    
	{
		if(!Find(a))           //ҪӦַ
		{
			if(Timer0_start == 0)//ʱ·
			{
				b = c;						 //ַַb
				for (b; *b!='\0';b++)
				{
					UART1_SendData(*b);
				}
				UART1_SendLR();	
				Times = 0;
				shijian = wait_time;
				Timer0_start = 1;  //ʼʱ
		   }
    }
 	  else
		{
			i = 1;
			Timer0_start = 0;  
		}
	}
	CLR_Buf1(); 
}

/*******************************************************************************
*  : Set_Pdu_Mode
*    : öΪTEXTıģʽ
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Set_Pdu_Mode(void)
{
	Second_AT_Command("ATE0","OK",3);										  //ȡ	
	Second_AT_Command("AT+CMGF=0","OK",3);								//PDUģʽ	
	Second_AT_Command("AT+CPMS=\"SM\",\"SM\",\"SM\"","OK",3);//вSIMн
}
/*******************************************************************************
*  : Send_Pdu_Sms
*    : PDUı
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Send_Pdu_Sms(void)
{

	Second_AT_Command("AT+CMGS=27",">",3); //ݳȣ27ļ㷽ڵԱȽϣյ>ŷͶ
	UART1_SendString(content);     //Ͷ
	UART1_SendData(0X1A);          //ͽ
}

/*******************************************************************************
*  : Wait_CREG
*    : ȴģעɹ
*    : 
*    : 
*    : 
* ע   : 
*******************************************************************************/
void Wait_CREG(void)
{
	u8 i;
	u8 k;
	i = 0;
	CLR_Buf1();
  while(i == 0)        			
	{
		CLR_Buf1();        
		UART1_SendString("AT+CREG?");//ѯģע״̬
		UART1_SendLR();
		delay_ms(250);  						
	    for(k=0;k<Buf1_Max;k++)      			
    	{
			if(Uart1_Buf[k] == ':')
			{
				if((Uart1_Buf[k+4] == '1')||(Uart1_Buf[k+4] == '5')) //עɹ
				{
					i = 1;
				  break;
				}
			}
		}
	}
}
