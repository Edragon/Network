C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: E:\mcu_keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND PRINT(..\Listing\main.lst) TABS(2) OBJ
                    -ECT(..\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  :À¶ÑÀ¿ØÖÆLED
   3           * ÃèÊö    :Í¨¹ýSTM32¿ª·¢°å´®¿Ú1¿ØÖÆÄ£¿é´ò¿ªÀ¶ÑÀ£»
   4                      µ±ÓëÊÖ»ú½¨Á¢À¶ÑÀSPPÁ¬½Óºó£¬Í¨¹ýÎÒÃÇÅäÌ×µÄÊÖ»úAPP£¬¿ØÖÆLEDµÄÁÁÃð£»
   5                      ÔËÐÐ³ÌÐòÇ°£¬½¨ÒéÏÈ´ò¿ªÎÒÃÇÅäÌ×µÄÊÖ»úÀ¶ÑÀ´®¿ÚÖúÊÖ¡£
   6           * ÊµÑéÆ½Ì¨:C51
   7          
   8           * Ó²¼þÁ¬½ÓËµÃ÷
   9             Ê¹ÓÃµ¥Æ¬´®¿ÚÓëGPRSÄ£¿éÍ¨ÐÅ 
  10             C51        GPRSÄ£¿é
  11             P30 (RXD)->RXD
  12             P31 (TXD)->TXD
  13             GND      ->GND
  14          
  15           * Èí¼þ¹¦ÄÜËµÃ÷
  16             ´ò¿ªÎÒÃÇÅäÌ×µÄÊÖ»úAPP£¬ÇÐ»»Ä£Ê½µ½¼à¿ØÕ¾Ä£Ê½£¬Í¨¹ý¡°°´¼ü1¡±¾Í¿ÉÒÔ¿ØÖÆLEDµÄÁÁÃð¡£
  17          **********************************************************************************/
  18          #include "config.h"
  19          #include "string.h"
  20          #include "delay.h"
  21          #include "uart.h"
  22          
  23          #define Buf1_Max 200            //´®¿Ú1»º´æ³¤¶È
  24          /*************  ±¾µØ³£Á¿ÉùÃ÷  **************/
  25          sbit RUNING_LED = P1^0;         //ÔËÐÐÖ¸Ê¾µÆ
  26          sbit LED        = P1^1;         //¿ØÖÆÖ¸Ê¾µÆ
  27          sbit LED1       = P1^4;
  28          sbit LED2       = P1^5;
  29          sbit LED3       = P1^6;
  30          sbit LED4       = P1^7;
  31          
  32          
  33          /*************  ±¾µØ±äÁ¿ÉùÃ÷  **************/
  34          xdata u8 Uart1_Buf[Buf1_Max];
  35          
  36          u16 Times=0;
  37          u8 First_Int = 0,shijian=0;
  38          u8 Timer_send=0;
  39          char *p1,*p2;
  40          bdata u8 Flag;//¶¨Ê±Æ÷±êÖ¾Î»
  41          sbit Timer0_start =Flag^0;  //¶¨Ê±Æ÷0ÑÓÊ±Æô¶¯¼ÆÊýÆ÷
  42          
  43          const char *sendtable="Niren-elec Bluetooth LED control\r\n\32";
  44          
  45          /*************  ±¾µØº¯ÊýÉùÃ÷  **************/
  46          void GPIO_config(void);   //Òý½Å³õÊ¼»¯
  47          void Timer0Init(void);    //¶¨Ê±Æ÷0³õÊ¼»¯
  48          void CLR_Buf1(void);      //Çå´®¿Ú½ÓÊÕ»º´æ
  49          u8 Find(u8 *a);           //²éÕÒ×Ö·û´®
  50          void Second_AT_Command(u8 *b,u8 *a,u8 wait_time);//·¢ËÍÖ¸Áî
  51          
  52          
  53          
  54          /*************  Íâ²¿º¯ÊýºÍ±äÁ¿ÉùÃ÷*****************/
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 2   

  55          
  56          
  57          
  58          
  59          /*******************************************************************************
  60          * º¯ÊýÃû : main 
  61          * ÃèÊö   : Ö÷º¯Êý
  62          * ÊäÈë   : 
  63          * Êä³ö   : 
  64          * ·µ»Ø   : 
  65          * ×¢Òâ   : ´®¿Ú²¨ÌØÂÊÊÇ9600£¬GPRSÄ£¿éÄ¬ÈÏ²¨ÌØÂÊÊÇ115200£¬ÐèÒª×Ô¼ºÍ¨¹ý´®¿ÚÖúÊÖÐÞ¸Ä
  66                     Îª9600·½¿ÉÊ¹ÓÃ¡£ 
  67                     ³ÌÐò»áÉ¾³ýÊÖ»ú¿¨ÉÏµÄ¶ÌÐÅ£¬Çë×¢Òâ
  68          *******************************************************************************/
  69          void main(void)
  70          {
  71   1        Timer0Init();  //³õÊ¼»¯¶¨Ê±Æ÷0
  72   1        GPIO_config();
  73   1        EA=1; //¿ª×ÜÖÐ¶Ï
  74   1        Uart1Init();    //³õÊ¼»¯´®¿Ú9600
  75   1          Second_AT_Command("ATE1\r\n","AT",2);//´ò¿ª»ØÏÔ
  76   1        Second_AT_Command("AT+BTPOWER=1\r\n","AT",2);//´ò¿ªÀ¶ÑÀµçÔ´,Õâ¸ö²»ÅÐ¶ÏOK£¬ÒòÎªµçÔ´Ô­±¾¿ªÆôÔÙ·¢ËÍ´ò¿ªµÄ»°»
             -á·µ»Ø´íÎó
  77   1        delay_ms(100);
  78   1        LED1=0;
  79   1           while(1)
  80   1          {
  81   2              if(strstr((const char*)Uart1_Buf,"BTPAIRING")!=NULL)//ÇëÇóÅä¶Ô
  82   2              {
  83   3                  CLR_Buf1();
  84   3                  Second_AT_Command("AT+BTPAIR=1,1\r\n","OK",3);//ÔÊÐíÊÖ»úÅä¶Ô
  85   3                  while(strstr((const char*)Uart1_Buf,"BTCONNECTING")==NULL);   //µÈ´ýÅä¶ÔÄ£¿é  
  86   3                  break;
  87   3              }else
  88   2              if(strstr((const char*)Uart1_Buf,"BTCONNECTING")!=NULL)//ÇëÇóÁ´½Ó
  89   2              {
  90   3                  break;
  91   3              }
  92   2          } 
  93   1        LED3=0;
  94   1          Second_AT_Command("AT+BTACPT=1\r\n","OK",3);//ÏìÓ¦Á¬½Ó
  95   1        CLR_Buf1();
  96   1        LED4=0;
  97   1        while(1)
  98   1        {
  99   2          //½ÓÊÕµ½Êý¾Ý
 100   2          if((p1=(char*)strstr((const char*)Uart1_Buf,"DATA:")),(p1!=NULL))//Ñ°ÕÒ¿ªÊ¼·û
 101   2          {   
 102   3              if((p2=(char*)strstr((const char*)p1,"\x0d\x0a")),(p2!=NULL))//Ñ°ÕÒ½áÊø·û
 103   3              {
 104   4                char *p3;
 105   4                *p2=0;//Ìí¼Ó½áÊø·û
 106   4                p3=strstr((const char*)p1,",");//ÊÕË÷µÚÒ»¸ö','
 107   4                p1=strstr((const char*)p3+1,",");//ÊÕË÷µÚ¶þ¸ö','
 108   4                //ÅÐ¶Ï°´¼ü
 109   4                if(*(p1+4)==(char)0XB1)
 110   4                {
 111   5                  LED =~LED;
 112   5                }
 113   4      
 114   4                CLR_Buf1(); 
 115   4              }
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 3   

 116   3          }else
 117   2          if(Timer_send>100)//¿ÕÏÐÊ±¶¨Ê±·¢ËÍÊý¾Ý
 118   2          { 
 119   3            Second_AT_Command("AT+BTSPPSEND",">",1);
 120   3            Second_AT_Command((char *)sendtable,"OK",1);
 121   3            Timer_send=0;
 122   3          }
 123   2        }
 124   1        
 125   1      }
 126          
 127          /*******************************************************************************
 128          * º¯ÊýÃû : Uart1 
 129          * ÃèÊö   : ´®¿Ú1ÖÐ¶Ï·þÎñÈë¿Úº¯Êý
 130          * ÊäÈë   : 
 131          * Êä³ö   : 
 132          * ·µ»Ø   : 
 133          * ×¢Òâ   : 
 134          *******************************************************************************/
 135          void Uart1() interrupt 4
 136          {
 137   1          if (RI)
 138   1          {
 139   2            RI = 0;                           //Çå³ýRIÎ»
 140   2            Uart1_Buf[First_Int] = SBUF;      //½«½ÓÊÕµ½µÄ×Ö·û´®´æµ½»º´æÖÐ
 141   2            First_Int++;                      //»º´æÖ¸ÕëÏòºóÒÆ¶¯
 142   2            if(First_Int > Buf1_Max)          //Èç¹û»º´æÂú,½«»º´æÖ¸ÕëÖ¸Ïò»º´æµÄÊ×µØÖ·
 143   2            {
 144   3              First_Int = 0;
 145   3            }
 146   2          }
 147   1          if (TI)
 148   1          {
 149   2              TI = 0;                          //Çå³ýTIÎ»
 150   2          }
 151   1      }
 152          
 153          /*******************************************************************************
 154          * º¯ÊýÃû : Timer0_ISR
 155          * ÃèÊö   : ¶¨Ê±Æ÷0ÖÐ¶Ï·þÎñÈë¿Úº¯Êý,20msÖÐ¶ÏÒ»´Î
 156          * ÊäÈë   : 
 157          * Êä³ö   : 
 158          * ·µ»Ø   : 
 159          * ×¢Òâ   : 
 160          *******************************************************************************/
 161          void Timer0_ISR() interrupt 1
 162          {
 163   1        static u8 Time_count=0; 
 164   1        TR0=0;//¹Ø¶¨Ê±Æ÷
 165   1        TL0 = 0x00;   //ÖØÉè¶¨Ê±Æ÷³õÖµ
 166   1        TH0 = 0xB8;   //ÖØÉè¶¨Ê±Æ÷³õÖµ
 167   1        Time_count++;
 168   1        if(Time_count>=50)
 169   1        {
 170   2          Time_count = 0;
 171   2          RUNING_LED =~RUNING_LED;
 172   2        }
 173   1        if(count_20ms) //20msÑÓÊ±¼ÆÊýÆ÷
 174   1          count_20ms--;
 175   1        if(Timer0_start)
 176   1          Times++;
 177   1        if(Times > (u16)(50*shijian))
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 4   

 178   1        {
 179   2          Timer0_start = 0;
 180   2          Times = 0;
 181   2        }
 182   1        Timer_send++;
 183   1        TR0=1;//¿ª¶¨Ê±Æ÷
 184   1      }
 185          /*******************************************************************************
 186          * º¯ÊýÃû : GPIO_config
 187          * ÃèÊö   : IO¿ÚÅäÖÃº¯Êý
 188          * ÊäÈë   : 
 189          * Êä³ö   : 
 190          * ·µ»Ø   : 
 191          * ×¢Òâ   : 
 192          *******************************************************************************/
 193          void  GPIO_config(void)
 194          {
 195   1          P1=0XFF;
 196   1          LED=1;
 197   1          RUNING_LED=1;
 198   1      }
 199          /*******************************************************************************
 200          * º¯ÊýÃû : Timer0Init
 201          * ÃèÊö   : ¶¨Ê±Æ÷0³õÊ¼»¯£¬20ms¶¨Ê±
 202          * ÊäÈë   : 
 203          * Êä³ö   : 
 204          * ·µ»Ø   : 
 205          * ×¢Òâ   : 
 206          *******************************************************************************/
 207          void Timer0Init(void)   //20ºÁÃë@11.0592MHz
 208          {
 209   1        AUXR &= 0x7F;   //¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
 210   1        TMOD &= 0xF0;   //
 211   1        TMOD |= 0x01;   //ÉèÖÃ¶¨Ê±Æ÷Ä£Ê½£¬16Î»¶¨Ê±Æ÷
 212   1        TL0 = 0x00;     //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 213   1        TH0 = 0xB8;     //ÉèÖÃ¶¨Ê±Æ÷³õÖµ
 214   1        TF0 = 0;        //ÇåTF0±êÖ¾
 215   1        TR0 = 1;        //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
 216   1        ET0 = 1;        //Ê¹ÄÜ¶¨Ê±Æ÷0ÖÐ¶Ï
 217   1      }
 218          /*******************************************************************************
 219          * º¯ÊýÃû : CLR_Buf1
 220          * ÃèÊö   : Çå³ý´®¿Ú2»º´æÊý¾Ý
 221          * ÊäÈë   : 
 222          * Êä³ö   : 
 223          * ·µ»Ø   : 
 224          * ×¢Òâ   : 
 225          *******************************************************************************/
 226          void CLR_Buf1(void)
 227          {
 228   1        u16 k;
 229   1        for(k=0;k<Buf1_Max;k++)      //½«»º´æÄÚÈÝÇåÁã
 230   1        {
 231   2          Uart1_Buf[k] = 0x00;
 232   2        }
 233   1          First_Int = 0;              //½ÓÊÕ×Ö·û´®µÄÆðÊ¼´æ´¢Î»ÖÃ
 234   1      }
 235          
 236          /*******************************************************************************
 237          * º¯ÊýÃû : Find
 238          * ÃèÊö   : ÅÐ¶Ï»º´æÖÐÊÇ·ñº¬ÓÐÖ¸¶¨µÄ×Ö·û´®
 239          * ÊäÈë   : 
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 5   

 240          * Êä³ö   : 
 241          * ·µ»Ø   : unsigned char:1 ÕÒµ½Ö¸¶¨×Ö·û£¬0 Î´ÕÒµ½Ö¸¶¨×Ö·û 
 242          * ×¢Òâ   : 
 243          *******************************************************************************/
 244          
 245          u8 Find(u8 *a)
 246          { 
 247   1        if(strstr(Uart1_Buf,a)!=NULL)
 248   1            return 1;
 249   1        else
 250   1            return 0;
 251   1      }
 252          
 253          /*******************************************************************************
 254          * º¯ÊýÃû : Second_AT_Command
 255          * ÃèÊö   : ·¢ËÍATÖ¸Áîº¯Êý
 256          * ÊäÈë   : ·¢ËÍÊý¾ÝµÄÖ¸Õë¡¢Ï£ÍûÊÕµ½µÄÓ¦´ð¡¢·¢ËÍµÈ´ýÊ±¼ä(µ¥Î»£ºS)
 257          * Êä³ö   : 
 258          * ·µ»Ø   : 
 259          * ×¢Òâ   : 
 260          *******************************************************************************/
 261          
 262          void Second_AT_Command(u8 *b,u8 *a,u8 wait_time)         
 263          {
 264   1        u8 i;
 265   1        u8 *c;
 266   1        c = b;                    //±£´æ×Ö·û´®µØÖ·µ½c
 267   1        CLR_Buf1(); 
 268   1        i = 0;
 269   1        while(i == 0)                    
 270   1        {
 271   2          if(!Find(a))            //²éÕÒÐèÒªÓ¦´ðµÄ×Ö·û
 272   2          {
 273   3            if(Timer0_start == 0)
 274   3            {
 275   4              CLR_Buf1(); 
 276   4              b = c;              //½«×Ö·û´®µØÖ·¸øb
 277   4              for (b; *b!='\0';b++)
 278   4              {
 279   5                UART1_SendData(*b);
 280   5              }
 281   4              UART1_SendLR(); 
 282   4              Times = 0;
 283   4              shijian = wait_time;
 284   4              Timer0_start = 1;
 285   4             }
 286   3          }
 287   2          else
 288   2          {
 289   3            i = 1;
 290   3            Timer0_start = 0;
 291   3          }
 292   2        }
 293   1        
 294   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    719    ----
   CONSTANT SIZE    =    143    ----
   XDATA SIZE       =    200    ----
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.00   MAIN                                                                  11/08/2016 17:56:49 PAGE 6   

   DATA SIZE        =     16      17
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
